<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3d space</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        canvas { display: block; }
        #error { color: red; position: absolute; top: 10px; left: 10px; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0, 0, 0, 0.8); padding: 10px; border-radius: 5px; }
        .instruction-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            max-width: 400px;
            font-size: 1.2em;
            transition: opacity 0.3s ease;
            opacity: 1;
        }
        .instruction-overlay.hidden { opacity: 0; pointer-events: none; }
        .instruction-overlay button {
            background-color: white;
            color: black;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        .instruction-overlay button:hover { background-color: #ddd; }
        #help-btn { position: fixed; top: 10px; right: 10px; }
        @media (max-width: 600px) {
            .instruction-overlay { max-width: 90%; font-size: 1em; padding: 15px; }
            .instruction-overlay button { padding: 8px 16px; }
        }
    </style>
    <script src="https://unpkg.com/three@0.134.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.134.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.min.js"></script>
</head>
<body>
    <div id="error" aria-live="polite"></div>
    <div id="loading" class="hidden">Loading...</div>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        const loadingManager = new THREE.LoadingManager();
        const textureLoader = new THREE.TextureLoader(loadingManager);
        const audioLoader = new THREE.AudioLoader(loadingManager);
        const listener = new THREE.AudioListener();
        const sounds = ['/snd/simoom.mp3', '/snd/mona.mp3'];
        const audioObjects = sounds.map(() => new THREE.Audio(listener));
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        document.addEventListener('DOMContentLoaded', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.add(listener);

            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enableZoom = true;
            controls.enablePan = true;
            controls.zoomSpeed = 0.5;
            controls.rotateSpeed = 0.5;
            camera.position.z = 5;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 1, 1);
            scene.add(directionalLight);

            const instructions = [
                "Welcome to the 3D Gallery!",
                "Use your mouse to orbit around the space or scroll to zoom.",
                "Click on paintings to hear associated audio.",
                "Press 'H' to revisit these instructions. Enjoy!"
            ];
            let currentInstruction = 0;

            const overlay = document.createElement('div');
            overlay.className = 'instruction-overlay';
            overlay.setAttribute('role', 'dialog');
            overlay.setAttribute('aria-modal', 'true');
            const text = document.createElement('p');
            text.id = 'instruction-text';
            text.textContent = instructions[0];
            const nextButton = document.createElement('button');
            nextButton.id = 'next-btn';
            nextButton.textContent = 'next';
            nextButton.setAttribute('aria-label', 'Next instruction');
            const skipButton = document.createElement('button');
            skipButton.id = 'skip-btn';
            skipButton.textContent = 'skip';
            skipButton.setAttribute('aria-label', 'Skip instructions');
            overlay.appendChild(text);
            overlay.appendChild(nextButton);
            overlay.appendChild(skipButton);
            document.body.appendChild(overlay);

            const helpButton = document.createElement('button');
            helpButton.id = 'help-btn';
            helpButton.textContent = 'Help';
            helpButton.classList.add('hidden');
            helpButton.setAttribute('aria-label', 'Show instructions');
            document.body.appendChild(helpButton);

            let lastFocusedElement = document.activeElement;
            nextButton.focus();

            nextButton.addEventListener('click', () => {
                currentInstruction++;
                if (currentInstruction < instructions.length) {
                    text.textContent = instructions[currentInstruction];
                    nextButton.textContent = currentInstruction === instructions.length - 1 ? 'start viewing' : 'next';
                } else {
                    overlay.classList.add('hidden');
                    helpButton.classList.remove('hidden');
                    lastFocusedElement.focus();
                }
            });
            skipButton.addEventListener('click', () => {
                overlay.classList.add('hidden');
                helpButton.classList.remove('hidden');
                lastFocusedElement.focus();
            });
            helpButton.addEventListener('click', () => {
                overlay.classList.remove('hidden');
                helpButton.classList.add('hidden');
                currentInstruction = 0;
                text.textContent = instructions[0];
                nextButton.textContent = 'next';
                nextButton.focus();
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !overlay.classList.contains('hidden')) {
                    skipButton.click();
                } else if (event.key === 'h' || event.key === 'H') {
                    helpButton.click();
                }
            });

            const positions = [[-3, 0, -5], [0, 0, -5], [3, 0, -5]];
            const imagePaths = ['/img/works/waverock.jpeg', '/img/works/naan.jpeg'];
            const paintings = [];

            loadingManager.onStart = () => document.getElementById('loading').classList.remove('hidden');
            loadingManager.onLoad = () => document.getElementById('loading').classList.add('hidden');
            loadingManager.onError = () => document.getElementById('error').textContent = 'Failed to load assets.';

            imagePaths.forEach((path, index) => {
                textureLoader.load(path, (texture) => {
                    const geometry = new THREE.PlaneGeometry(2, 2);
                    const material = new THREE.MeshStandardMaterial({ map: texture });
                    const plane = new THREE.Mesh(geometry, material);
                    plane.position.set(...positions[index]);
                    scene.add(plane);
                    paintings.push(plane);
                }, undefined, () => {
                    document.getElementById('error').textContent = `Failed to load image: ${path}`;
                });
            });

            sounds.forEach((sound, index) => {
                audioLoader.load(sound, (buffer) => {
                    audioObjects[index].setBuffer(buffer);
                }, undefined, () => {
                    document.getElementById('error').textContent = `Failed to load audio: ${sound}`;
                });
            });

            let activePainting = null;
            function onClick(event) {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(paintings);
                if (intersects.length > 0) {
                    const painting = intersects[0].object;
                    const index = paintings.indexOf(painting);
                    if (index >= 0 && index < audioObjects.length) {
                        if (activePainting) activePainting.material.emissive.set(0x000000);
                        painting.material.emissive.set(0x555555);
                        activePainting = painting;
                        painting.material.color.set(0xffff00);
                        setTimeout(() => painting.material.color.set(0xffffff), 200);
                        audioObjects.forEach((audio, i) => {
                            if (i !== index && audio.isPlaying) audio.stop();
                        });
                        if (audioObjects[index].hasBuffer) {
                            audioObjects[index].play();
                        }
                    }
                }
            }

            window.addEventListener('click', onClick);
            window.addEventListener('touchstart', (event) => {
                const touch = event.touches[0];
                onClick({ clientX: touch.clientX, clientY: touch.clientY });
            });

            window.addEventListener('mousemove', (event) => {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(paintings);
                paintings.forEach(p => {
                    p.scale.set(1, 1, 1);
                    if (p !== activePainting) p.material.emissive.set(0x000000);
                });
                if (intersects.length > 0) {
                    const painting = intersects[0].object;
                    painting.scale.set(1.1, 1.1, 1);
                    if (painting !== activePainting) painting.material.emissive.set(0x333333);
                }
            });

            function animate() {
                requestAnimationFrame(animate);
                TWEEN.update();
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            window.addEventListener('unload', () => {
                window.removeEventListener('click', onClick);
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('resize', onResize);
                renderer.dispose();
            });
        });
    </script>
</body>
</html>